
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>20. DML for ATE and LATE of 401(k) on Wealth &#8212; Inference on Causal and Structural Parametters Using ML and AI</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="21. Identification Analysis of 401(k) Example w DAGs" href="21_Identification%20Analysis%20of%20401%28k%29%20Example%20w%20DAGs.html" />
    <link rel="prev" title="19. DML inference using NN for gun ownership" href="19_pm3_notebook_inference_nn.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/main_logo_ai_light.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Inference on Causal and Structural Parametters Using ML and AI</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_Python_Notebook_Linear_Model_Overfitting.html">
   1. Linear Model Overfiting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_ols-and-lasso-for-wage-prediction.html">
   2. OLS and lasso for wage prediction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_ols-and-lasso-for-gender-wage-gap-inference.html">
   3. OLS and lasso for gender wage gap inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_py-notebook-some-rct-examples.html">
   4. Some RCT Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_py-notebook-analyzing-rct-with-precision.html">
   5. Analyzing RCT reemployment experiment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_analyzing-rct-reemployment-experiment.html">
   6. Analyzing RCT reemployment experiment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_py-notebook-linear-penalized-regs.html">
   7. Linear Penalized Regs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_ML_for_wage_prediction.html">
   8. ML for wage prediction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_py-notebook-experiment-on-orthogonal-learning.html">
   9. Experiment on orthogonal Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_double-lasso-for-the-convergence-hypothesis.html">
   10. Double Lasso for Testing the Convergence Hypothesis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_py-heterogenous-wage-effects.html">
   11. Heterogenous Wage Effects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_py-colliderbias-hollywood.html">
   12. ColliderBias Hollywood# Collider Bias
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_deep_neural_networks_for_wage_prediction.html">
   13. Deep Neural Networks for Wage Prediction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_automl-for-wage-prediction.html">
   14. AutoML for wage prediction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_py-Functional-Approximation-By-NN-and-RF.html">
   15. Functional Approximation By NN and RF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_notebook_dagitty.html">
   16. Notebook-DAGitty
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_notebook-dosearch.html">
   17. Notebook-Dosearch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="18_pm3_notebook_inference_clustering.html">
   18. DML inference for gun ownership
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="19_pm3_notebook_inference_nn.html">
   19. DML inference using NN for gun ownership
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   20. DML for ATE and LATE of 401(k) on Wealth
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="21_Identification%20Analysis%20of%20401%28k%29%20Example%20w%20DAGs.html">
   21. Identification Analysis of 401(k) Example w DAGs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="22_debiased-ml-for-partially-linear-model-in-python.html">
   22. Debiased ML for Partially Linear Model in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="23_sensitivity_analysis_with_sensmakr_and_debiased_ml.html">
   23. Sensitivity Analysis with Sensmakr and Debiased ML
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="24_debiased-ml-for-partially-linear-iv-model-in-python.html">
   24. Debiased ML for Partially Linear IV Model in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="25_r_weak_iv_experiments.html">
   25. Weak IV Experiments
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/d2cml-ai/14.388_py/master?urlpath=tree/_build/jupyter_execute/Python_notebooks/20_pm5-401k-kaggle-py.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/d2cml-ai/14.388_py/blob/master/_build/jupyter_execute/Python_notebooks/20_pm5-401k-kaggle-py.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/d2cml-ai/14.388_py"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/d2cml-ai/14.388_py/issues/new?title=Issue%20on%20page%20%2FPython_notebooks/20_pm5-401k-kaggle-py.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/d2cml-ai/14.388_py/edit/master/_build/jupyter_execute/Python_notebooks/20_pm5-401k-kaggle-py.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/Python_notebooks/20_pm5-401k-kaggle-py.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models">
   20.1. Inference on Predictive and Causal Effects in High-Dimensional Nonlinear Models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#impact-of-401-k-on-financial-wealth">
   20.2. Impact of 401(k) on  Financial Wealth
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   20.3. Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#double-ml-package">
   20.4. Double ML package
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#estimating-the-ate-of-401-k-eligibility-on-net-financial-assets">
   20.5. Estimating the ATE of 401(k) Eligibility on Net Financial Assets
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#main-data">
     20.5.1. Main Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#auxiliary-data">
     20.5.2. Auxiliary data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#partially-linear-regression-models-plr">
   20.6. Partially Linear Regression Models (PLR)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sklearn-vs-ranger">
     20.6.1. Sklearn VS Ranger
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sklearn-vs-rpart">
     20.6.2. Sklearn VS Rpart
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-regression-model-irm">
   20.7. Interactive Regression Model (IRM)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#local-average-treatment-effects-of-401-k-participation-on-net-financial-assets">
   20.8. Local Average Treatment Effects of 401(k) Participation on Net Financial Assets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-iv-model-iivm">
   20.9. Interactive IV Model (IIVM)
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>DML for ATE and LATE of 401(k) on Wealth</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models">
   20.1. Inference on Predictive and Causal Effects in High-Dimensional Nonlinear Models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#impact-of-401-k-on-financial-wealth">
   20.2. Impact of 401(k) on  Financial Wealth
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   20.3. Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#double-ml-package">
   20.4. Double ML package
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#estimating-the-ate-of-401-k-eligibility-on-net-financial-assets">
   20.5. Estimating the ATE of 401(k) Eligibility on Net Financial Assets
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#main-data">
     20.5.1. Main Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#auxiliary-data">
     20.5.2. Auxiliary data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#partially-linear-regression-models-plr">
   20.6. Partially Linear Regression Models (PLR)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sklearn-vs-ranger">
     20.6.1. Sklearn VS Ranger
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sklearn-vs-rpart">
     20.6.2. Sklearn VS Rpart
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-regression-model-irm">
   20.7. Interactive Regression Model (IRM)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#local-average-treatment-effects-of-401-k-participation-on-net-financial-assets">
   20.8. Local Average Treatment Effects of 401(k) Participation on Net Financial Assets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#interactive-iv-model-iivm">
   20.9. Interactive IV Model (IIVM)
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="dml-for-ate-and-late-of-401-k-on-wealth">
<h1><span class="section-number">20. </span>DML for ATE and LATE of 401(k) on Wealth<a class="headerlink" href="#dml-for-ate-and-late-of-401-k-on-wealth" title="Permalink to this headline">#</a></h1>
<section id="inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models">
<h2><span class="section-number">20.1. </span>Inference on Predictive and Causal Effects in High-Dimensional Nonlinear Models<a class="headerlink" href="#inference-on-predictive-and-causal-effects-in-high-dimensional-nonlinear-models" title="Permalink to this headline">#</a></h2>
</section>
<section id="impact-of-401-k-on-financial-wealth">
<h2><span class="section-number">20.2. </span>Impact of 401(k) on  Financial Wealth<a class="headerlink" href="#impact-of-401-k-on-financial-wealth" title="Permalink to this headline">#</a></h2>
<p>As a practical illustration of the methods developed in this lecture, we consider estimation of the effect of 401(k) eligibility and participation
on accumulated assets. 401(k) plans are pension accounts sponsored by employers. The key problem in determining the effect of participation in 401(k) plans on accumulated assets is saver heterogeneity coupled with the fact that the decision to enroll in a 401(k) is non-random. It is generally recognized that some people have a higher preference for saving than others. It also seems likely that those individuals with high unobserved preference for saving would be most likely to choose to participate in tax-advantaged retirement savings plans and would tend to have otherwise high amounts of accumulated assets. The presence of unobserved savings preferences with these properties then implies that conventional estimates that do not account for saver heterogeneity and endogeneity of participation will be biased upward, tending to overstate the savings effects of 401(k) participation.</p>
<p>One can argue that eligibility for enrolling in a 401(k) plan in this data can be taken as exogenous after conditioning on a few observables of which the most important for their argument is income. The basic idea is that, at least around the time 401(k)’s initially became available, people were unlikely to be basing their employment decisions on whether an employer offered a 401(k) but would instead focus on income and other aspects of the job.</p>
</section>
<section id="data">
<h2><span class="section-number">20.3. </span>Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h2>
<p>The data set can be loaded from the <code class="docutils literal notranslate"><span class="pre">hdm</span></code> package for R by typing</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#pip install -U DoubleML</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">doubleml</span> <span class="k">as</span> <span class="nn">dml</span>
<span class="kn">from</span> <span class="nn">doubleml.datasets</span> <span class="kn">import</span> <span class="n">fetch_401K</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LassoCV</span><span class="p">,</span> <span class="n">LogisticRegressionCV</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>

<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span><span class="p">,</span> <span class="n">XGBRegressor</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">hdmpy</span>
<span class="kn">import</span> <span class="nn">pyreadr</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">link</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/d2cml-ai/14.388_py/main/data/pension.RData&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">fhandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="s1">&#39;pension.Rdata&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="n">fhandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pyreadr</span><span class="o">.</span><span class="n">read_r</span><span class="p">(</span><span class="s2">&quot;pension.Rdata&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;pension.Rdata&quot;</span><span class="p">)</span>

<span class="c1"># Extracting the data frame from rdata_read</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span> <span class="s1">&#39;pension&#39;</span> <span class="p">]</span>
<span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(9915, 44)
</pre></div>
</div>
</div>
</div>
<p>See the “Details” section on the description of the data set, which can be accessed by</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pension</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The data consist of 9,915 observations at the household level drawn from the 1991 Survey of Income and Program Participation (SIPP).  All the variables are referred to 1990. We use net financial assets (<em>net_tfa</em>) as the outcome variable, <span class="math notranslate nohighlight">\(Y\)</span>,  in our analysis. The net financial assets are computed as the sum of IRA balances, 401(k) balances, checking accounts, saving bonds, other interest-earning accounts, other interest-earning assets, stocks, and mutual funds less non mortgage debts.</p>
<p>Among the <span class="math notranslate nohighlight">\(9915\)</span> individuals, <span class="math notranslate nohighlight">\(3682\)</span> are eligible to participate in the program. The variable <em>e401</em> indicates eligibility and <em>p401</em> indicates participation, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;e401&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Eligibility, 401(k)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;e401&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20_pm5-401k-kaggle-py_12_0.png" src="../_images/20_pm5-401k-kaggle-py_12_0.png" />
</div>
</div>
<p>Eligibility is highly associated with financial wealth:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;net_tfa&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;e401&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;e401&quot;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;kde&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20_pm5-401k-kaggle-py_14_0.png" src="../_images/20_pm5-401k-kaggle-py_14_0.png" />
</div>
</div>
<p>The unconditional APE of e401 is about <span class="math notranslate nohighlight">\(19559\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="s1">&#39;net_tfa&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;e401&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>net_tfa</th>
    </tr>
    <tr>
      <th>e401</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>19559.34475</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Among the <span class="math notranslate nohighlight">\(3682\)</span> individuals that  are eligible, <span class="math notranslate nohighlight">\(2594\)</span> decided to participate in the program. The unconditional APE of p401 is about <span class="math notranslate nohighlight">\(27372\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="s1">&#39;net_tfa&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;p401&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>net_tfa</th>
    </tr>
    <tr>
      <th>p401</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>27371.583404</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As discussed, these estimates are biased since they do not account for saver heterogeneity and endogeneity of participation.</p>
</section>
<section id="double-ml-package">
<h2><span class="section-number">20.4. </span>Double ML package<a class="headerlink" href="#double-ml-package" title="Permalink to this headline">#</a></h2>
<p>We are interested in valid estimators of the average treatment effect of <code class="docutils literal notranslate"><span class="pre">e401</span></code> and <code class="docutils literal notranslate"><span class="pre">p401</span></code> on <code class="docutils literal notranslate"><span class="pre">net_tfa</span></code>. To get those estimators, we use the <code class="docutils literal notranslate"><span class="pre">DoubleML</span></code> package that internally builds on mlr3. You find additional information on the package on the package website <a class="reference external" href="https://docs.doubleml.org/">https://docs.doubleml.org/</a> and the R documentation page <a class="reference external" href="https://docs.doubleml.org/r/stable/">https://docs.doubleml.org/r/stable/</a>.</p>
<p>As mentioned, in the tutorial we use the meta package <code class="docutils literal notranslate"><span class="pre">mlr3</span></code> to generate predictions with machine learning methods. A comprehensive introduction and description of the <code class="docutils literal notranslate"><span class="pre">mlr3</span></code> package is provided in the <a class="reference external" href="https://mlr3book.mlr-org.com/">mlr3book</a>. A list of all learners that you can use in <code class="docutils literal notranslate"><span class="pre">mlr3</span></code> can be found <a class="reference external" href="https://mlr3extralearners.mlr-org.com/articles/learners/list_learners.html">here</a>. The entry in the columns <em>mlr3 Package</em> and <em>Packages</em> indicate which packages must be installed/loaded in your R session.</p>
</section>
<section id="estimating-the-ate-of-401-k-eligibility-on-net-financial-assets">
<h2><span class="section-number">20.5. </span>Estimating the ATE of 401(k) Eligibility on Net Financial Assets<a class="headerlink" href="#estimating-the-ate-of-401-k-eligibility-on-net-financial-assets" title="Permalink to this headline">#</a></h2>
<p>We first look at the treatment effect of e401 on net total financial assets. We give estimates of the ATE and ATT that corresponds to the linear model</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
Y = D \alpha + f(X)'\beta+ \epsilon
\end{align}
\]</div>
<p>where <span class="math notranslate nohighlight">\(f(X)\)</span> includes indicators of marital status, two-earner status, defined benefit pension status, IRA participation status, and home ownership status, and  orthogonal polynomials of degrees 2, 4, 6 and 8 in family size, education, age and  income, respectively. The dimensions of <span class="math notranslate nohighlight">\(f(X)\)</span> is 25.</p>
<p>In the first step, we report estimates of the average treatment effect (ATE) of 401(k) eligibility on net financial assets both in the partially linear regression (PLR) model and in the interactive regression model (IRM) allowing for heterogeneous treatment effects.</p>
<p>We can not use np.log in <code class="docutils literal notranslate"><span class="pre">inc</span></code> variable since it has negative values. As a result, we got a column with some <code class="docutils literal notranslate"><span class="pre">None</span></code> values. Those observations have problems with <code class="docutils literal notranslate"><span class="pre">poly.fit_transform</span></code> function since it does not admit <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values <strong>(uncomment and run the code below for a example)</strong>. I decided to low down the degree of the polynomial to <strong>6</strong> for some estimations: random forest, decision trees, etc. So, we are going to use create datasets: <strong>data_ml</strong> (8 degree <code class="docutils literal notranslate"><span class="pre">inc</span></code>) and <strong>data_ml_aux</strong> (6 degree <code class="docutils literal notranslate"><span class="pre">inc</span></code>).</p>
<section id="main-data">
<h3><span class="section-number">20.5.1. </span>Main Data<a class="headerlink" href="#main-data" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constructing the data (as DoubleMLData)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;marr&#39;</span><span class="p">,</span> <span class="s1">&#39;twoearn&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;pira&#39;</span><span class="p">,</span> <span class="s1">&#39;hown&#39;</span><span class="p">]]</span>

<span class="n">poly_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
             <span class="s1">&#39;inc&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
             <span class="s1">&#39;educ&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
             <span class="s1">&#39;fsize&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">degree</span> <span class="ow">in</span> <span class="n">poly_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_transf</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="n">key</span><span class="p">]])</span>
    <span class="n">x_cols</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
    <span class="n">data_transf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_transf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">x_cols</span><span class="p">)</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">data_transf</span><span class="p">),</span>
                          <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">model_flex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">]],</span> <span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">x_cols</span> <span class="o">=</span> <span class="n">model_flex</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span>

<span class="c1"># Initialize DoubleMLData (data-backend of DoubleML)</span>
<span class="n">data_ml</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLData</span><span class="p">(</span><span class="n">model_flex</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> \
                           <span class="n">d_cols</span> <span class="o">=</span><span class="s1">&#39;e401&#39;</span> <span class="p">,</span> <span class="n">x_cols</span> <span class="o">=</span> <span class="n">x_cols</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">model_flex</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>25
</pre></div>
</div>
</div>
</div>
</section>
<section id="auxiliary-data">
<h3><span class="section-number">20.5.2. </span>Auxiliary data<a class="headerlink" href="#auxiliary-data" title="Permalink to this headline">#</a></h3>
<p>We are going to use this data since sklearn has some problems with values greater than <code class="docutils literal notranslate"><span class="pre">float32</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constructing the data (as DoubleMLData)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;marr&#39;</span><span class="p">,</span> <span class="s1">&#39;twoearn&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;pira&#39;</span><span class="p">,</span> <span class="s1">&#39;hown&#39;</span><span class="p">]]</span>

<span class="n">poly_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
             <span class="s1">&#39;inc&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
             <span class="s1">&#39;educ&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
             <span class="s1">&#39;fsize&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">degree</span> <span class="ow">in</span> <span class="n">poly_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_transf</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="n">key</span><span class="p">]])</span>
    <span class="n">x_cols</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
    <span class="n">data_transf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_transf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">x_cols</span><span class="p">)</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">data_transf</span><span class="p">),</span>
                          <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">model_flex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">]],</span> <span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">x_cols</span> <span class="o">=</span> <span class="n">model_flex</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span>

<span class="c1"># Initialize DoubleMLData (data-backend of DoubleML)</span>
<span class="n">data_ml_aux</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLData</span><span class="p">(</span><span class="n">model_flex</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> \
                           <span class="n">d_cols</span> <span class="o">=</span><span class="s1">&#39;e401&#39;</span> <span class="p">,</span> <span class="n">x_cols</span> <span class="o">=</span> <span class="n">x_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># data_interactions</span>
<span class="c1">#fetch_401K( return_type  = &#39;DataFrame&#39; , polynomial_features = True )</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="partially-linear-regression-models-plr">
<h2><span class="section-number">20.6. </span>Partially Linear Regression Models (PLR)<a class="headerlink" href="#partially-linear-regression-models-plr" title="Permalink to this headline">#</a></h2>
<p>We start using lasso to estimate the function <span class="math notranslate nohighlight">\(g_0\)</span> and <span class="math notranslate nohighlight">\(m_0\)</span> in the following PLR model:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}\tag{1}
Y = D\theta_0 + g_0(X) + \zeta,  &amp;  E[\zeta \mid D,X]= 0,\\
\end{align}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[
\begin{align}\tag{2}
D = m_0(X) +  V,   &amp;  E[V \mid X] = 0.
\end{align}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize learners</span>
<span class="n">Cs</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">))</span>
<span class="n">lasso_class</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span>
                            <span class="n">LogisticRegressionCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
                                                 <span class="n">Cs</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="c1"># Initialize DoubleMLPLR model</span>
<span class="n">dml_plr</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span><span class="n">data_ml_aux</span><span class="p">,</span>
                                <span class="n">ml_g</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">,</span>
                                <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_plr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">lasso_plr</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lasso_std_plr</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;std err&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
      <th>std err</th>
      <th>t</th>
      <th>P&gt;|t|</th>
      <th>2.5 %</th>
      <th>97.5 %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>e401</th>
      <td>8919.577401</td>
      <td>1325.857662</td>
      <td>6.727402</td>
      <td>1.727192e-11</td>
      <td>6320.944135</td>
      <td>11518.210667</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let us check the predictive performance of this model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;ml_l&#39;, &#39;ml_m&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_o</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;ml_l&#39;, &#39;ml_m&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">predictions_y</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">theta</span> <span class="o">+</span> <span class="n">g_hat</span>
<span class="n">lasso_y_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">predictions_y</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="n">lasso_y_rmse</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>54342.02430847791
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">lasso_d_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">lasso_d_rmse</span> <span class="p">)</span>
<span class="c1"># cross-fitted ce: treatment</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">m_hat</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">d</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4585164421000309
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.31376701966717097
</pre></div>
</div>
</div>
</div>
<p>Then, we repeat this procedure for various machine learning methods.</p>
<section id="sklearn-vs-ranger">
<h3><span class="section-number">20.6.1. </span>Sklearn VS Ranger<a class="headerlink" href="#sklearn-vs-ranger" title="Permalink to this headline">#</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Sklearn <strong>(by default)</strong></p></th>
<th class="head"><p>Ranger <strong>(by default) <a class="reference external" href="https://www.jstatsoft.org/article/view/v077i01">info</a></strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>max_features = “auto” =n_features</p></td>
<td><p>mtry = Null = 0</p></td>
</tr>
<tr class="row-odd"><td><p>max_depth = None</p></td>
<td><p>max.depth = Null = 0</p></td>
</tr>
<tr class="row-even"><td><p>min_samples_leaf = 1</p></td>
<td><p>min.node.size = Null = 0</p></td>
</tr>
<tr class="row-odd"><td><p>n_estimators = 100</p></td>
<td><p>num.trees = 500</p></td>
</tr>
</tbody>
</table>
<p>We assured that <code class="docutils literal notranslate"><span class="pre">data_ml</span></code> in <strong>Python</strong> is exactly like the data generated by <strong>R</strong>. <br />
Even though we tried to adjust parameters of Sklearn models to meet default values of ranger, we could not overcome the NA  and Inf problems in predictions. We decided to use another package, <code class="docutils literal notranslate"><span class="pre">skranger</span></code>, which is a simil of <code class="docutils literal notranslate"><span class="pre">ranger</span></code> in <strong>Python</strong>. However, we got some problems installing the package in Windows10.</p>
<p>After reviewing the packages and reading <a class="reference external" href="https://github.com/bikashkarmokar/float32_bug_sklearn">this repository</a>, we conclude that Sklearn has problems with values greater than <code class="docutils literal notranslate"><span class="pre">float32</span></code>, and <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> consider these values as <code class="docutils literal notranslate"><span class="pre">Inf</span></code>. Based on that information, we decided to use tha auxiliary data (<strong>data_ml_aux</strong>) for <code class="docutils literal notranslate"><span class="pre">RandomForestRegressor</span></code> and <code class="docutils literal notranslate"><span class="pre">DecisionTreeRegressor</span></code>.</p>
<p>We are going to use only income up to 6th grade since, <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> has problems with numbers greater than float32. We decided to reduce numbers’ size.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">data_ml</span></code> in <strong>Python</strong> is equal to the generated by <strong>R</strong>.</p>
<p>We can compare the accuracy of this model to the model that has been estimated with lasso.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random Forest</span>
<span class="n">randomForest</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
    <span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">500</span>  <span class="p">)</span>

<span class="n">randomForest_class</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">500</span> <span class="p">)</span>


<span class="n">dml_plr</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span><span class="n">data_ml_aux</span><span class="p">,</span> <span class="n">ml_g</span> <span class="o">=</span> <span class="n">randomForest</span><span class="p">,</span> \
                         <span class="n">ml_m</span> <span class="o">=</span> <span class="n">randomForest_class</span><span class="p">,</span> <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_plr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span>

<span class="n">forest_plr</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">coef</span>
<span class="n">forest_std_plr</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span> <span class="s1">&#39;std err&#39;</span> <span class="p">]</span>

<span class="c1"># Evaluation predictions</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_o</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">predictions_y</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">theta</span> <span class="o">+</span> <span class="n">g_hat</span>
<span class="n">forest_y_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">predictions_y</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_y_rmse</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">forest_d_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_d_rmse</span> <span class="p">)</span>
<span class="c1"># cross-fitted ce: treatment</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">m_hat</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">d</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>58456.527347918534
0.4659644938522823
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3495713565305093
</pre></div>
</div>
</div>
</div>
</section>
<section id="sklearn-vs-rpart">
<h3><span class="section-number">20.6.2. </span>Sklearn VS Rpart<a class="headerlink" href="#sklearn-vs-rpart" title="Permalink to this headline">#</a></h3>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Sklearn (default)</p></th>
<th class="head"><p>Rpart.control (defualt)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>min_samples_split = 2</p></td>
<td><p>minsplit = 20</p></td>
</tr>
<tr class="row-odd"><td><p>max_depth = None (pure tree| &lt; min_samples_split)</p></td>
<td><p>maxdepth = 30</p></td>
</tr>
<tr class="row-even"><td><p>min_samples_leaf = 1</p></td>
<td><p>minbucket = round( <code class="docutils literal notranslate"><span class="pre">minsplit</span></code>/3 )</p></td>
</tr>
<tr class="row-odd"><td><p>ccp_alpha = 0.0</p></td>
<td><p>cp = 0.01 (doubts)</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Trees</span>
<span class="n">trees</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span>
        <span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ccp_alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> \
        <span class="n">min_samples_leaf</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">20</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

<span class="n">trees_class</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ccp_alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> \
                <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> \
                <span class="n">min_samples_leaf</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">20</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_plr</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span><span class="n">data_ml_aux</span><span class="p">,</span>
                               <span class="n">ml_g</span> <span class="o">=</span> <span class="n">trees</span><span class="p">,</span>
                               <span class="n">ml_m</span> <span class="o">=</span> <span class="n">trees_class</span><span class="p">,</span>
                               <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">dml_plr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tree_summary</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tree_summary</span><span class="p">)</span>

<span class="n">dml_plr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span>

<span class="n">tree_plr</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">coef</span>
<span class="n">tree_std_plr</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span> <span class="s1">&#39;std err&#39;</span> <span class="p">]</span>

<span class="c1"># Evaluation predictions</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_o</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">predictions_y</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">theta</span> <span class="o">+</span> <span class="n">g_hat</span>
<span class="n">tree_y_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">predictions_y</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_y_rmse</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">tree_d_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_d_rmse</span> <span class="p">)</span>
<span class="c1"># cross-fitted ce: treatment</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">m_hat</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">d</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             coef      std err         t         P&gt;|t|        2.5 %  \
e401  8594.661891  1383.808638  6.210875  5.269052e-10  5882.446799   

            97.5 %  
e401  11306.876983  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>58017.721042321384
0.4546690531536573
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.35269793242561776
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boosted Trees</span>
<span class="n">boost</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;reg:squarederror&quot;</span> <span class="p">)</span>
<span class="n">boost_class</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;binary:logistic&quot;</span><span class="p">,</span> \
                            <span class="n">eval_metric</span> <span class="o">=</span> <span class="s2">&quot;logloss&quot;</span> <span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_plr</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span> <span class="n">data_ml_aux</span> <span class="p">,</span>
                                <span class="n">ml_g</span> <span class="o">=</span> <span class="n">boost</span><span class="p">,</span>
                                <span class="n">ml_m</span> <span class="o">=</span> <span class="n">boost_class</span><span class="p">,</span>
                                <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">dml_plr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">boost_summary</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_summary</span> <span class="p">)</span>

<span class="n">boost_plr</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">coef</span>
<span class="n">boost_std_plr</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span> <span class="s1">&#39;std err&#39;</span> <span class="p">]</span>

<span class="c1"># Evaluation predictions</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_o</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="n">dml_plr</span><span class="o">.</span><span class="n">params_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">dml_plr</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">predictions_y</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">theta</span> <span class="o">+</span> <span class="n">g_hat</span>

<span class="n">boost_y_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">predictions_y</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_y_rmse</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">boost_d_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_d_rmse</span> <span class="p">)</span>

<span class="c1"># cross-fitted ce: treatment</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">m_hat</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">d</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             coef      std err         t         P&gt;|t|        2.5 %  \
e401  9129.263678  1471.781415  6.202867  5.544386e-10  6244.625111   

            97.5 %  
e401  12013.902244  
62126.68237198471
0.4629817464588606
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.33605648008068584
</pre></div>
</div>
</div>
</div>
<p>Let’s sum up the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_plr</span><span class="p">,</span><span class="n">forest_plr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tree_plr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">boost_plr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_std_plr</span><span class="p">,</span><span class="n">forest_std_plr</span><span class="p">,</span><span class="n">tree_std_plr</span><span class="p">,</span><span class="n">boost_std_plr</span>
<span class="n">table</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_y_rmse</span><span class="p">,</span><span class="n">forest_y_rmse</span><span class="p">,</span><span class="n">tree_y_rmse</span><span class="p">,</span><span class="n">boost_y_rmse</span>
<span class="n">table</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_d_rmse</span><span class="p">,</span><span class="n">forest_d_rmse</span><span class="p">,</span><span class="n">tree_d_rmse</span><span class="p">,</span><span class="n">boost_d_rmse</span>
<span class="n">table_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">table</span> <span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span><span class="s2">&quot;Std.Error&quot;</span><span class="p">,</span><span class="s2">&quot;RMSE Y&quot;</span><span class="p">,</span><span class="s2">&quot;RMSE D&quot;</span> <span class="p">],</span> \
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;Lasso&quot;</span><span class="p">,</span><span class="s2">&quot;Random Forest&quot;</span><span class="p">,</span><span class="s2">&quot;Trees&quot;</span><span class="p">,</span><span class="s2">&quot;Boosting&quot;</span><span class="p">])</span>
<span class="n">table_pd</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lasso</th>
      <th>Random Forest</th>
      <th>Trees</th>
      <th>Boosting</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Estimate</th>
      <td>8919.577401</td>
      <td>8702.588054</td>
      <td>8601.584926</td>
      <td>9129.263678</td>
    </tr>
    <tr>
      <th>Std.Error</th>
      <td>1325.857662</td>
      <td>1310.423641</td>
      <td>1383.825475</td>
      <td>1471.781415</td>
    </tr>
    <tr>
      <th>RMSE Y</th>
      <td>54342.024308</td>
      <td>58456.527348</td>
      <td>58017.721042</td>
      <td>62126.682372</td>
    </tr>
    <tr>
      <th>RMSE D</th>
      <td>0.458516</td>
      <td>0.465964</td>
      <td>0.454669</td>
      <td>0.462982</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The best model with lowest RMSE in both equation is the PLR model estimated via lasso. It gives the following estimate:</p>
</section>
</section>
<section id="interactive-regression-model-irm">
<h2><span class="section-number">20.7. </span>Interactive Regression Model (IRM)<a class="headerlink" href="#interactive-regression-model-irm" title="Permalink to this headline">#</a></h2>
<p>Next, we consider estimation of average treatment effects when treatment effects are fully heterogeneous:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}\tag{3}
 &amp; Y  = g_0(D, X) + U,  &amp;  \quad E[U \mid X, D]= 0,\\
\end{align} 
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[
\begin{align}\tag{4}
  &amp; D  = m_0(X) + V,  &amp; \quad  E[V\mid X] = 0.
\end{align}
\]</div>
<p>To reduce the disproportionate impact of extreme propensity score weights in the interactive model
we trim the propensity scores which are close to the bounds.</p>
<p>We have problems with the <strong>Lasso code</strong>. When we run the code with the main data (<strong>data_ml</strong>) we got a very high coefficient (30964, <strong>uncomment and run the code below to see results</strong>). However, when I run the code with the auxiliary data (<strong>data_aux</strong>), I get results similar to the R output.  I assume that <code class="docutils literal notranslate"><span class="pre">inc^7</span></code> and <code class="docutils literal notranslate"><span class="pre">inc^8</span></code> variables are making troubles in Sklearn models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lasso</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">))</span>

<span class="c1"># Initialize DoubleMLIRM model</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_ml_aux</span><span class="p">,</span>
                          <span class="n">ml_g</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">,</span>
                          <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                          <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                          <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">dml_irm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="n">lasso_summary</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_irm</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>

<span class="n">lasso_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lasso_std_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">se</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">dml_irm</span><span class="o">.</span><span class="n">params_names</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># predictions</span>
<span class="n">g0_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(D=0, X)</span>
<span class="n">g1_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(D=1, X)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">g1_hat</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="p">)</span><span class="o">*</span><span class="n">g0_hat</span> <span class="c1"># predictions of g_0</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>

<span class="n">lasso_y_irm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">g_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">lasso_y_irm</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">lasso_d_irm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">lasso_d_irm</span> <span class="p">)</span>

<span class="c1"># cross-fitted ce: treatment</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">m_hat</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">d</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             coef      std err         t         P&gt;|t|        2.5 %  \
e401  8089.763322  1270.047728  6.369653  1.894563e-10  5600.515516   

            97.5 %  
e401  10579.011127  
[&#39;ml_g0&#39;, &#39;ml_g1&#39;, &#39;ml_m&#39;]
54497.27607070186
0.45851619758764794
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.31376701966717097
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random Forest</span>
<span class="n">randomForest</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">randomForest_class</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_ml_aux</span><span class="p">,</span>
                                 <span class="n">ml_g</span> <span class="o">=</span> <span class="n">randomForest</span><span class="p">,</span>
                                 <span class="n">ml_m</span> <span class="o">=</span> <span class="n">randomForest_class</span><span class="p">,</span>
                                 <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                 <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>


<span class="n">dml_irm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">store_predictions</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span> 
<span class="n">forest_summary</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_summary</span> <span class="p">)</span>

<span class="n">forest_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">forest_std_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">se</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>


<span class="c1"># predictions</span>
<span class="n">g0_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(D=0, X)</span>
<span class="n">g1_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(D=1, X)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">g1_hat</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="p">)</span><span class="o">*</span><span class="n">g0_hat</span> <span class="c1"># predictions of g_0</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>

<span class="n">forest_y_irm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">g_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_y_irm</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">forest_d_irm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_d_irm</span> <span class="p">)</span>

<span class="c1"># cross-fitted ce: treatment</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">m_hat</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">d</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             coef      std err         t         P&gt;|t|        2.5 %  \
e401  8429.821206  1521.201806  5.541554  2.997999e-08  5448.320453   

           97.5 %  
e401  11411.32196  
56839.92174410771
0.46312674664653625
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.33767019667170955
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Trees</span>
<span class="n">trees</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ccp_alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">67</span><span class="p">)</span>
<span class="n">trees_class</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ccp_alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">34</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_ml_aux</span><span class="p">,</span>
                                 <span class="n">ml_g</span> <span class="o">=</span> <span class="n">trees</span><span class="p">,</span>
                                 <span class="n">ml_m</span> <span class="o">=</span> <span class="n">trees_class</span><span class="p">,</span>
                                 <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                 <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>


<span class="n">dml_irm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">store_predictions</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span> 
<span class="n">tree_summary</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_summary</span> <span class="p">)</span>

<span class="n">tree_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">tree_std_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">se</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>


<span class="c1"># predictions</span>
<span class="n">g0_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(D=0, X)</span>
<span class="n">g1_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(D=1, X)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">g1_hat</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="p">)</span><span class="o">*</span><span class="n">g0_hat</span> <span class="c1"># predictions of g_0</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>

<span class="n">tree_y_irm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">g_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_y_irm</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">tree_d_irm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_d_irm</span> <span class="p">)</span>

<span class="c1"># cross-fitted ce: treatment</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">m_hat</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">d</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             coef      std err         t         P&gt;|t|        2.5 %  \
e401  7462.262513  1171.316712  6.370832  1.880049e-10  5166.523942   

           97.5 %  
e401  9758.001083  
56517.04167292204
0.4546690531536573
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.35269793242561776
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boosted Trees</span>
<span class="n">boost</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;reg:squarederror&quot;</span><span class="p">)</span>
<span class="n">boost_class</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">eval_metric</span> <span class="o">=</span> <span class="s2">&quot;logloss&quot;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_ml_aux</span><span class="p">,</span>
                                 <span class="n">ml_g</span> <span class="o">=</span> <span class="n">boost</span><span class="p">,</span>
                                 <span class="n">ml_m</span> <span class="o">=</span> <span class="n">boost_class</span><span class="p">,</span>
                                 <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                 <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>


<span class="n">dml_irm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">store_predictions</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span> 
<span class="n">boost_summary</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_summary</span> <span class="p">)</span>

<span class="n">boost_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">boost_std_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">se</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>


<span class="c1"># predictions</span>
<span class="n">g0_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(D=0, X)</span>
<span class="n">g1_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(D=1, X)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">g1_hat</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="p">)</span><span class="o">*</span><span class="n">g0_hat</span> <span class="c1"># predictions of g_0</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>

<span class="n">boost_y_irm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">g_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_y_irm</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">boost_d_irm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_d_irm</span> <span class="p">)</span>

<span class="c1"># cross-fitted ce: treatment</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">m_hat</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">d</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             coef      std err        t     P&gt;|t|        2.5 %       97.5 %
e401  9756.926817  2500.320649  3.90227  0.000095  4856.388395  14657.46524
61594.80967416296
0.46296289075787445
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.33605648008068584
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<span class="n">table2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_irm</span><span class="p">,</span><span class="n">forest_irm</span><span class="p">,</span><span class="n">tree_irm</span><span class="p">,</span><span class="n">boost_irm</span>
<span class="n">table2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_std_irm</span><span class="p">,</span><span class="n">forest_std_irm</span><span class="p">,</span><span class="n">tree_std_irm</span><span class="p">,</span><span class="n">boost_std_irm</span>
<span class="n">table2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_y_irm</span><span class="p">,</span><span class="n">forest_y_irm</span><span class="p">,</span><span class="n">tree_y_irm</span><span class="p">,</span><span class="n">boost_y_irm</span>
<span class="n">table2</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_d_irm</span><span class="p">,</span><span class="n">forest_d_irm</span><span class="p">,</span><span class="n">tree_d_irm</span><span class="p">,</span><span class="n">boost_d_irm</span>

<span class="n">table2_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">table2</span> <span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span><span class="s2">&quot;Std.Error&quot;</span><span class="p">,</span><span class="s2">&quot;RMSE Y&quot;</span><span class="p">,</span><span class="s2">&quot;RMSE D&quot;</span> <span class="p">],</span> \
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;Lasso&quot;</span><span class="p">,</span><span class="s2">&quot;Random Forest&quot;</span><span class="p">,</span><span class="s2">&quot;Trees&quot;</span><span class="p">,</span><span class="s2">&quot;Boosting&quot;</span><span class="p">])</span>
<span class="n">table2_pd</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lasso</th>
      <th>Random Forest</th>
      <th>Trees</th>
      <th>Boosting</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Estimate</th>
      <td>8089.763322</td>
      <td>8429.821206</td>
      <td>7462.262513</td>
      <td>9756.926817</td>
    </tr>
    <tr>
      <th>Std.Error</th>
      <td>1270.047728</td>
      <td>1521.201806</td>
      <td>1171.316712</td>
      <td>2500.320649</td>
    </tr>
    <tr>
      <th>RMSE Y</th>
      <td>54497.276071</td>
      <td>56839.921744</td>
      <td>56517.041673</td>
      <td>61594.809674</td>
    </tr>
    <tr>
      <th>RMSE D</th>
      <td>0.458516</td>
      <td>0.463127</td>
      <td>0.454669</td>
      <td>0.462963</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Here, Random Forest gives the best prediction rule for <span class="math notranslate nohighlight">\(g_0\)</span> and Lasso the best prediction rule for <span class="math notranslate nohighlight">\(m_0\)</span>, respectively. Let us fit the IRM model using the best ML method for each equation to get a final estimate for the treatment effect of eligibility.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_ml_aux</span><span class="p">,</span>
                          <span class="n">ml_g</span> <span class="o">=</span> <span class="n">randomForest</span><span class="p">,</span>
                          <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                          <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                          <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_irm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">summary</span> <span class="p">)</span>

<span class="n">best_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">best_std_irm</span> <span class="o">=</span> <span class="n">dml_irm</span><span class="o">.</span><span class="n">se</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             coef      std err         t         P&gt;|t|        2.5 %  \
e401  8403.399751  1348.088788  6.233565  4.559366e-10  5761.194279   

            97.5 %  
e401  11045.605224  
</pre></div>
</div>
</div>
</div>
<p>These estimates that flexibly account for confounding are
substantially attenuated relative to the baseline estimate (<em>19559</em>) that does not account for confounding. They suggest much smaller causal effects of 401(k) eligiblity on financial asset holdings.</p>
</section>
<section id="local-average-treatment-effects-of-401-k-participation-on-net-financial-assets">
<h2><span class="section-number">20.8. </span>Local Average Treatment Effects of 401(k) Participation on Net Financial Assets<a class="headerlink" href="#local-average-treatment-effects-of-401-k-participation-on-net-financial-assets" title="Permalink to this headline">#</a></h2>
</section>
<section id="interactive-iv-model-iivm">
<h2><span class="section-number">20.9. </span>Interactive IV Model (IIVM)<a class="headerlink" href="#interactive-iv-model-iivm" title="Permalink to this headline">#</a></h2>
<p>Now, we consider estimation of local average treatment effects (LATE) of participation with the binary instrument <code class="docutils literal notranslate"><span class="pre">e401</span></code>. As before, <span class="math notranslate nohighlight">\(Y\)</span> denotes the outcome <code class="docutils literal notranslate"><span class="pre">net_tfa</span></code>, and <span class="math notranslate nohighlight">\(X\)</span> is the vector of covariates.  Here the structural equation model is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}\tag{5}
&amp; Y = g_0(Z,X) + U, &amp;\quad E[U\mid Z,X] = 0,\\
\end{align}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}\tag{6}
&amp; D = r_0(Z,X) + V, &amp;\quad E[V\mid Z, X] = 0,\\
\end{align}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[
\begin{align}\tag{7}
&amp; Z = m_0(X) + \zeta, &amp;\quad E[\zeta \mid X] = 0.
\end{align}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Constructing the data (as DoubleMLData)</span>
<span class="c1"># features = data.copy()[[&#39;marr&#39;, &#39;twoearn&#39;, &#39;db&#39;, &#39;pira&#39;, &#39;hown&#39;]]</span>

<span class="c1"># poly_dict = {&#39;age&#39;: 6,</span>
<span class="c1">#              &#39;inc&#39;: 8,</span>
<span class="c1">#              &#39;educ&#39;: 4,</span>
<span class="c1">#              &#39;fsize&#39;: 2}</span>
<span class="c1"># for key, degree in poly_dict.items():</span>
<span class="c1">#     poly = PolynomialFeatures(degree, include_bias=False)</span>
<span class="c1">#     data_transf = poly.fit_transform(data[[key]])</span>
<span class="c1">#     x_cols = poly.get_feature_names([key])</span>
<span class="c1">#     data_transf = pd.DataFrame(data_transf, columns=x_cols)</span>
    
<span class="c1">#     features = pd.concat((features, data_transf),</span>
<span class="c1">#                           axis=1, sort=False)</span>

<span class="c1"># model_flex2 = pd.concat((data.copy()[[&#39;net_tfa&#39;, &#39;p401&#39; , &#39;e401&#39;]], features.copy()),</span>
<span class="c1">#                         axis=1, sort=False)</span>

<span class="c1"># x_cols = model_flex2.columns.to_list()[3:]</span>

<span class="c1"># # Initialize DoubleMLData (data-backend of DoubleML)</span>
<span class="c1"># data_IV = dml.DoubleMLData(model_flex2, y_col=&#39;net_tfa&#39;, \</span>
<span class="c1">#                                d_cols =&#39;p401&#39; , z_cols = &#39;e401&#39; , \</span>
<span class="c1">#                                x_cols = x_cols)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constructing the data (as DoubleMLData)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;marr&#39;</span><span class="p">,</span> <span class="s1">&#39;twoearn&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;pira&#39;</span><span class="p">,</span> <span class="s1">&#39;hown&#39;</span><span class="p">]]</span>

<span class="n">poly_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
             <span class="s1">&#39;inc&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
             <span class="s1">&#39;educ&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
             <span class="s1">&#39;fsize&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">degree</span> <span class="ow">in</span> <span class="n">poly_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_transf</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="n">key</span><span class="p">]])</span>
    <span class="n">x_cols</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
    <span class="n">data_transf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_transf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">x_cols</span><span class="p">)</span>
    
    <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">data_transf</span><span class="p">),</span>
                          <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">model_flex2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span> <span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">]],</span> <span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">x_cols</span> <span class="o">=</span> <span class="n">model_flex2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()[</span><span class="mi">3</span><span class="p">:]</span>

<span class="c1"># Initialize DoubleMLData (data-backend of DoubleML)</span>
<span class="n">data_IV_aux</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLData</span><span class="p">(</span><span class="n">model_flex2</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> \
                               <span class="n">d_cols</span> <span class="o">=</span><span class="s1">&#39;p401&#39;</span> <span class="p">,</span> <span class="n">z_cols</span> <span class="o">=</span> <span class="s1">&#39;e401&#39;</span> <span class="p">,</span> \
                               <span class="n">x_cols</span> <span class="o">=</span> <span class="n">x_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lasso</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">))</span>

<span class="c1"># Initialize DoubleMLIRM model</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_MLIIVM</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_IV_aux</span><span class="p">,</span>
                                  <span class="n">ml_g</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">,</span>
                                  <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                  <span class="n">ml_r</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                  <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                  <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lasso_summary</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">lasso_summary</span> <span class="p">)</span>
<span class="n">lasso_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">lasso_std_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">se</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              coef      std err         t         P&gt;|t|        2.5 %  \
p401  11764.551405  1842.601194  6.384752  1.716756e-10  8153.119428   

            97.5 %  
p401  15375.983383  
</pre></div>
</div>
</div>
</div>
<p>The confidence interval for the local average treatment effect of participation is given by</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">confint</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2.5 %</th>
      <th>97.5 %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>p401</th>
      <td>8153.119428</td>
      <td>15375.983383</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># variables</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">p401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># predictions</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">params_names</span> <span class="p">)</span>
<span class="n">g0_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(z=0, X)</span>
<span class="n">g1_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(z=1, X)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">g1_hat</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="p">)</span><span class="o">*</span><span class="n">g0_hat</span> <span class="c1"># predictions of g_0</span>
<span class="n">r0_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_r0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of r_0(z=0, X)</span>
<span class="n">r1_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_r1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of r_0(z=1, X)</span>
<span class="n">r_hat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">r1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">r0_hat</span> <span class="c1"># predictions of r_0</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>





<span class="c1"># cross-fitted RMSE: outcome</span>
<span class="n">lasso_y_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">g_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">lasso_y_MLIIVM</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">lasso_d_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">r_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">lasso_d_MLIIVM</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: instrument</span>
<span class="n">lasso_z_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">z</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">lasso_z_MLIIVM</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;ml_g0&#39;, &#39;ml_g1&#39;, &#39;ml_m&#39;, &#39;ml_r0&#39;, &#39;ml_r1&#39;]
54127.27882639755
0.2786204170023307
0.45851619758764794
</pre></div>
</div>
</div>
</div>
<p>Again, we repeat the procedure for the other machine learning methods:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random Forest</span>
<span class="n">randomForest</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">randomForest_class</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_MLIIVM</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_IV_aux</span><span class="p">,</span>
                                  <span class="n">ml_g</span> <span class="o">=</span> <span class="n">randomForest</span><span class="p">,</span>
                                  <span class="n">ml_m</span> <span class="o">=</span> <span class="n">randomForest_class</span><span class="p">,</span>
                                  <span class="n">ml_r</span> <span class="o">=</span> <span class="n">randomForest_class</span><span class="p">,</span>
                                  <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                  <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">forest_summary</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_summary</span> <span class="p">)</span>
<span class="n">forest_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">forest_std_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">se</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>

<span class="c1"># variables</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">p401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># predictions</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">params_names</span> <span class="p">)</span>
<span class="n">g0_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(z=0, X)</span>
<span class="n">g1_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(z=1, X)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">g1_hat</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="p">)</span><span class="o">*</span><span class="n">g0_hat</span> <span class="c1"># predictions of g_0</span>
<span class="n">r0_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_r0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of r_0(z=0, X)</span>
<span class="n">r1_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_r1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of r_0(z=1, X)</span>
<span class="n">r_hat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">r1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">r0_hat</span> <span class="c1"># predictions of r_0</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>

<span class="c1"># cross-fitted RMSE: outcome</span>
<span class="n">forest_y_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">g_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_y_MLIIVM</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">forest_d_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">r_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_d_MLIIVM</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: instrument</span>
<span class="n">forest_z_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">z</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">forest_z_MLIIVM</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              coef      std err         t         P&gt;|t|        2.5 %  \
p401  11823.312322  2162.030668  5.468615  4.535669e-08  7585.810079   

            97.5 %  
p401  16060.814565  
[&#39;ml_g0&#39;, &#39;ml_g1&#39;, &#39;ml_m&#39;, &#39;ml_r0&#39;, &#39;ml_r1&#39;]
57014.35978884377
0.28397007364006993
0.46312674664653625
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random tree</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_MLIIVM</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_IV_aux</span><span class="p">,</span>
                                  <span class="n">ml_g</span> <span class="o">=</span> <span class="n">trees</span><span class="p">,</span>
                                  <span class="n">ml_m</span> <span class="o">=</span> <span class="n">trees_class</span><span class="p">,</span>
                                  <span class="n">ml_r</span> <span class="o">=</span> <span class="n">trees_class</span><span class="p">,</span>
                                  <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                  <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tree_summary</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_summary</span> <span class="p">)</span>
<span class="n">tree_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">tree_std_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">se</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>

<span class="c1"># variables</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">p401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># predictions</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">params_names</span> <span class="p">)</span>
<span class="n">g0_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(z=0, X)</span>
<span class="n">g1_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(z=1, X)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">g1_hat</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="p">)</span><span class="o">*</span><span class="n">g0_hat</span> <span class="c1"># predictions of g_0</span>
<span class="n">r0_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_r0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of r_0(z=0, X)</span>
<span class="n">r1_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_r1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of r_0(z=1, X)</span>
<span class="n">r_hat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">r1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">r0_hat</span> <span class="c1"># predictions of r_0</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>





<span class="c1"># cross-fitted RMSE: outcome</span>
<span class="n">tree_y_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">g_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_y_MLIIVM</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">tree_d_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">r_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_d_MLIIVM</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: instrument</span>
<span class="n">tree_z_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">z</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">tree_z_MLIIVM</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              coef      std err         t         P&gt;|t|        2.5 %  \
p401  10652.033245  1665.615224  6.395254  1.602802e-10  7387.487395   

            97.5 %  
p401  13916.579095  
[&#39;ml_g0&#39;, &#39;ml_g1&#39;, &#39;ml_m&#39;, &#39;ml_r0&#39;, &#39;ml_r1&#39;]
56317.410732152974
0.278215621782697
0.4546690531536573
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random boost</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_MLIIVM</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_IV_aux</span><span class="p">,</span>
                                  <span class="n">ml_g</span> <span class="o">=</span> <span class="n">boost</span><span class="p">,</span>
                                  <span class="n">ml_m</span> <span class="o">=</span> <span class="n">boost_class</span><span class="p">,</span>
                                  <span class="n">ml_r</span> <span class="o">=</span> <span class="n">boost_class</span><span class="p">,</span>
                                  <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                  <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">boost_summary</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_summary</span> <span class="p">)</span>
<span class="n">boost_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">boost_std_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">se</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>

<span class="c1"># variables</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">net_tfa</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">p401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">pension</span><span class="o">.</span><span class="n">e401</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="c1"># predictions</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">params_names</span> <span class="p">)</span>
<span class="n">g0_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(z=0, X)</span>
<span class="n">g1_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of g_0(z=1, X)</span>
<span class="n">g_hat</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">g1_hat</span> <span class="o">+</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span> <span class="p">)</span><span class="o">*</span><span class="n">g0_hat</span> <span class="c1"># predictions of g_0</span>
<span class="n">r0_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_r0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of r_0(z=0, X)</span>
<span class="n">r1_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_r1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of r_0(z=1, X)</span>
<span class="n">r_hat</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">r1_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">r0_hat</span> <span class="c1"># predictions of r_0</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># predictions of m_o</span>





<span class="c1"># cross-fitted RMSE: outcome</span>
<span class="n">boost_y_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">g_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_y_MLIIVM</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: treatment</span>
<span class="n">boost_d_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">d</span> <span class="o">-</span> <span class="n">r_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_d_MLIIVM</span> <span class="p">)</span>

<span class="c1"># cross-fitted RMSE: instrument</span>
<span class="n">boost_z_MLIIVM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="p">(</span> <span class="n">z</span> <span class="o">-</span> <span class="n">m_hat</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span> <span class="n">boost_z_MLIIVM</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              coef      std err         t     P&gt;|t|        2.5 %        97.5 %
p401  13593.184614  3490.834608  3.893964  0.000099  6751.274506  20435.094721
[&#39;ml_g0&#39;, &#39;ml_g1&#39;, &#39;ml_m&#39;, &#39;ml_r0&#39;, &#39;ml_r1&#39;]
61407.11615253673
0.2960100530837048
0.46296289075787445
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<span class="n">table3</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_MLIIVM</span><span class="p">,</span><span class="n">forest_MLIIVM</span><span class="p">,</span><span class="n">tree_MLIIVM</span><span class="p">,</span><span class="n">boost_MLIIVM</span>
<span class="n">table3</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_std_MLIIVM</span><span class="p">,</span><span class="n">forest_std_MLIIVM</span><span class="p">,</span><span class="n">tree_std_MLIIVM</span><span class="p">,</span><span class="n">boost_std_MLIIVM</span>
<span class="n">table3</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_y_MLIIVM</span><span class="p">,</span><span class="n">forest_y_MLIIVM</span><span class="p">,</span><span class="n">tree_y_MLIIVM</span><span class="p">,</span><span class="n">boost_y_MLIIVM</span>
<span class="n">table3</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_d_MLIIVM</span><span class="p">,</span><span class="n">forest_d_MLIIVM</span><span class="p">,</span><span class="n">tree_d_MLIIVM</span><span class="p">,</span><span class="n">boost_d_MLIIVM</span>
<span class="n">table3</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">lasso_z_MLIIVM</span><span class="p">,</span><span class="n">forest_z_MLIIVM</span><span class="p">,</span><span class="n">tree_z_MLIIVM</span><span class="p">,</span><span class="n">boost_z_MLIIVM</span>

<span class="n">table3_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">table3</span> <span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Estimate&quot;</span><span class="p">,</span><span class="s2">&quot;Std.Error&quot;</span><span class="p">,</span><span class="s2">&quot;RMSE Y&quot;</span><span class="p">,</span><span class="s2">&quot;RMSE D&quot;</span><span class="p">,</span><span class="s2">&quot;RMSE Z&quot;</span> <span class="p">],</span> \
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;Lasso&quot;</span><span class="p">,</span><span class="s2">&quot;Random Forest&quot;</span><span class="p">,</span><span class="s2">&quot;Trees&quot;</span><span class="p">,</span><span class="s2">&quot;Boosting&quot;</span><span class="p">])</span>
<span class="n">table3_pd</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lasso</th>
      <th>Random Forest</th>
      <th>Trees</th>
      <th>Boosting</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Estimate</th>
      <td>11764.551405</td>
      <td>11823.312322</td>
      <td>10652.033245</td>
      <td>13593.184614</td>
    </tr>
    <tr>
      <th>Std.Error</th>
      <td>1842.601194</td>
      <td>2162.030668</td>
      <td>1665.615224</td>
      <td>3490.834608</td>
    </tr>
    <tr>
      <th>RMSE Y</th>
      <td>54127.278826</td>
      <td>57014.359789</td>
      <td>56317.410732</td>
      <td>61407.116153</td>
    </tr>
    <tr>
      <th>RMSE D</th>
      <td>0.278620</td>
      <td>0.283970</td>
      <td>0.278216</td>
      <td>0.296010</td>
    </tr>
    <tr>
      <th>RMSE Z</th>
      <td>0.458516</td>
      <td>0.463127</td>
      <td>0.454669</td>
      <td>0.462963</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We report results based on four ML methods for estimating the nuisance functions used in
forming the orthogonal estimating equations. We find again that the estimates of the treatment effect are stable across ML methods. The estimates are highly significant, hence we would reject the hypothesis
that the effect of 401(k) participation has no effect on financial health.</p>
<p>We might rerun the model using the best ML method for each equation to get a final estimate for the treatment effect of participation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random best</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_MLIIVM</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_IV_aux</span><span class="p">,</span>
                                  <span class="n">ml_g</span> <span class="o">=</span> <span class="n">randomForest</span><span class="p">,</span>
                                  <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                  <span class="n">ml_r</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                  <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                  <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">best_summary</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">summary</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">best_summary</span> <span class="p">)</span>
<span class="n">best_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
<span class="n">best_std_MLIIVM</span> <span class="o">=</span> <span class="n">dml_MLIIVM</span><span class="o">.</span><span class="n">se</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              coef      std err         t         P&gt;|t|       2.5 %  \
p401  12220.624723  1957.387719  6.243334  4.283417e-10  8384.21529   

            97.5 %  
p401  16057.034157  
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "d2cml-ai/14.388_py",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Python_notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="19_pm3_notebook_inference_nn.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">19. </span>DML inference using NN for gun ownership</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="21_Identification%20Analysis%20of%20401%28k%29%20Example%20w%20DAGs.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">21. </span>Identification Analysis of 401(k) Example w DAGs</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Victor Chernozhukov<br/>
  
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>